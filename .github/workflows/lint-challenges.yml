name: Lint challenges

on:
  push:
    branches:
      - main
    paths:
      - "**/challenge.yml"
  pull_request:
    paths:
      - "**/challenge.yml"
  workflow_dispatch:

jobs:
  get-chals:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      challenges: ${{ github.event_name == 'workflow_dispatch' && '**/challenge.yml' || steps.changed-files.outputs.all_changed_and_modified_files }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35
        with:
          files: "**/challenge.yml"

  deploy:
    needs: get-chals
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # https://github.com/actions/checkout/issues/165#issuecomment-1639209867
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Setup ctfcli
        run: pip install git+https://github.com/CTFd/ctfcli # ctfcli==0.0.14

      - name: Load CTFd credentials
        run: |
          mkdir .ctf
          cat <<EOF > .ctf/config
          [config]
          url = https://${{ vars.CTFD_DOMAIN }}
          access_token = ${{ secrets.CTFD_TOKEN }}

          [cookies]
          site_password = ${{ secrets.CTFD_SITE_PASSWORD }}

          [challenges]
          EOF

      # TODO use 'ctf' once fixed
      - name: Lint challenges
        run: |
          for chal in ${{ needs.get-chals.outputs.challenges }}; do
            python -m ctfcli challenge lint $chal
          done
